<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR Ring Try-On</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://threejs.org/build/three.js"></script>
</head>
<body>
    <div id="loading">Loading...</div>
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;' style="display: none;">
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene').object3D; // 获取A-Frame场景的Three.js对象

            loadModel()
                .then(model => {
                    scene.add(model); // 将戒指模型添加到场景
                    initHandTracking();
                    document.getElementById('loading').style.display = 'none';
                    document.querySelector('a-scene').style.display = 'block';
                })
                .catch(error => {
                    document.getElementById('loading').textContent = 'Failed to load model: ' + error.message;
                });

            function loadModel() {
                return new Promise((resolve, reject) => {
                    const loader = new THREE.GLTFLoader();
                    loader.load('assets/ring_model.glb',
                        gltf => resolve(gltf.scene), // 成功加载
                        undefined,
                        error => reject(error) // 加载失败
                    );
                });
            }

            function initHandTracking() {
                const hands = new Hands({
                    locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                const videoElement = document.createElement('video');
                const camera = new Camera(videoElement, {
                    onFrame: async () => {
                        try {
                            await hands.send({ image: videoElement });
                        } catch (error) {
                            console.error('Failed to send image to MediaPipe:', error);
                        }
                    },
                    width: 1280,
                    height: 720
                });
                camera.start();
                hands.onResults(results => {
                    if (results.multiHandLandmarks) {
                        updateRingPosition(results.multiHandLandmarks[0], scene.children[scene.children.length - 1]); // Assume the last added mesh is the ring
                    }
                });
            }

            function updateRingPosition(handLandmarks, ringMesh) {
                // Update ring position based on hand landmarks
                // Similar to previous updateRingPosition function content
            }
        });
    </script>
</body>
</html>
