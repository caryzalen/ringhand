<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR Hand Tracking</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline style="display: none;"></video>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
    <script>
        const video = document.getElementById('video');

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });
            video.srcObject = stream;

            return new Promise(resolve => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        setupCamera();

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        video.addEventListener('loadeddata', (event) => {
            const camera = new Camera(video, {
                onFrame: async () => {
                    await hands.send({ image: video });
                },
                width: 1280,
                height: 720
            });
            camera.start();
        });

        let scene, camera3D, renderer, spheres = [];

        function initThreeJS() {
            scene = new THREE.Scene();
            camera3D = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            camera3D.position.z = 2;
        }

        function createSphere() {
            const geometry = new THREE.SphereGeometry(0.01, 32, 32);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            return sphere;
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];

                // 初始化球
                if (spheres.length === 0) {
                    for (let i = 0; i < landmarks.length; i++) {
                        spheres.push(createSphere());
                    }
                }

                // 更新球的位置
                for (let i = 0; i < landmarks.length; i++) {
                    const landmark = landmarks[i];
                    const sphere = spheres[i];
                    sphere.position.set(
                        landmark.x * 2 - 1, // X coordinates normalized to [-1, 1]
                        -landmark.y * 2 + 1, // Y coordinates normalized to [-1, 1] and inverted
                        landmark.z * -1 // Z coordinates
                    );
                }
            }

            renderer.render(scene, camera3D);
        }

        initThreeJS();
    </script>
</body>
</html>
